name: Build (Windows)

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    # Run only in SAM-BIM org; skip fork PRs because secrets are not available there
    if: |
      github.repository_owner == 'SAM-BIM' &&
      (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)

    runs-on: windows-2022

    env:
      MSBUILDDISABLENODEREUSE: "1"
      ORG_NAME: "SAM-BIM"
      REPO_NAME: "SAM_Rhino_UI"

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: ${{ env.REPO_NAME }}

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.x"

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Clone dependency repos (siblings)
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.ORG_REPO_TOKEN }}
        run: |
          $ErrorActionPreference = 'Stop'

          if (-not $env:GH_TOKEN) {
            throw "Missing secret ORG_REPO_TOKEN. Add it in repo Settings → Secrets and variables → Actions."
          }

          $org  = '${{ env.ORG_NAME }}'
          $repo = '${{ env.REPO_NAME }}'

          # Full dependency chain (same as SAM_UI), plus private SAM_Solver
          # Keep the current repo LAST.
          $buildOrder = @(
            'SAM'
            'SAM_Solver'
            'SAM_Systems'
            'SAM_Windows'
            'SAM_Mollier'
            'SAM_gbXML'
            'SAM_SolarCalculator'
            'SAM_Tas'
            'SAM_Excel'
            'SAM_GEM'
            'SAM_LadybugTools'
            'SAM_UI'
            $repo
          )

          # Clone everything except the last one (already checked out by Actions)
          $deps = $buildOrder[0..($buildOrder.Count-2)]
          foreach ($r in $deps) {
            if (Test-Path $r) { continue }

            # Use token URL for all clones (works for public + private)
            $url = "https://x-access-token:$($env:GH_TOKEN)@github.com/$org/$r.git"

            Write-Host "Cloning $org/$r"
            git clone --depth 1 $url $r

            if ($LASTEXITCODE -ne 0 -or -not (Test-Path $r)) {
              throw "Failed to clone $org/$r. Check token permissions (Contents: Read) and repo access."
            }
          }

          # Ensure ReferencePath exists even before SAM_Windows builds
          New-Item -ItemType Directory -Force -Path "SAM_Windows\build" | Out-Null

      - name: Restore + Rebuild in order (CI props like SAM_Deploy)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $repo = '${{ env.REPO_NAME }}'
          $windowsRef = (Resolve-Path 'SAM_Windows\build').Path

          $common = @(
            '/m:1'
            '/nr:false'
            '/v:m'
            '/p:Configuration=Release'
            '/p:UseSharedCompilation=false'
            '/p:RunPostBuildEvent=OnOutputUpdated'
            "/p:ReferencePath=$windowsRef"
          )

          $buildOrder = @(
            'SAM'
            'SAM_Solver'
            'SAM_Systems'
            'SAM_Windows'
            'SAM_Mollier'
            'SAM_gbXML'
            'SAM_SolarCalculator'
            'SAM_Tas'
            'SAM_Excel'
            'SAM_GEM'
            'SAM_LadybugTools'
            'SAM_UI'
            $repo
          )

          $solutions = foreach ($r in $buildOrder) {
            $sln = Get-ChildItem -Path $r -Filter *.sln -File | Select-Object -First 1
            if (-not $sln) { throw "No .sln found under: $r" }
            $sln.FullName
          }

          foreach ($sln in $solutions) {
            Write-Host "==> Restore: $sln"
            & msbuild $sln /t:Restore @common
            if ($LASTEXITCODE -ne 0) { throw "Restore failed: $sln" }
          }

          foreach ($sln in $solutions) {
            Write-Host "==> Rebuild: $sln"
            & msbuild $sln /t:Rebuild @common
            if ($LASTEXITCODE -ne 0) { throw "Build failed: $sln" }
          }

      - name: Upload build folders (optional)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REPO_NAME }}-build-folders
          path: |
            **\build\*
          if-no-files-found: warn
